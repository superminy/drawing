<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÌïúÍ∏Ä ÏûêÏùå Ïì∞Í∏∞ ÎÜÄÏù¥</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        body {
            font-family: 'Jua', sans-serif;
            background-color: #e8f5e9;
            /* Light Green theme */
            color: #333;
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow: hidden;
            touch-action: none;
        }

        h1 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #fff;
            border: 2px solid #4caf50;
            border-radius: 20px;
            padding: 10px 15px;
            text-decoration: none;
            color: #4caf50;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            z-index: 1000;
        }

        .home-btn:hover {
            transform: scale(1.05);
            background: #e8f5e9;
        }

        .selector-container {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .char-btn {
            background-color: #fff;
            border: 2px solid #66bb6a;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            font-size: 20px;
            font-family: 'Jua', sans-serif;
            color: #2e7d32;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .char-btn:hover {
            transform: scale(1.1);
            background-color: #c8e6c9;
        }

        .char-btn.active {
            background-color: #4caf50;
            color: white;
            border-color: #2e7d32;
            transform: scale(1.15);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #canvas-container {
            position: relative;
            width: 300px;
            height: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 8px solid #a5d6a7;
            overflow: hidden;
            transform: scale(1.3);
            transform-origin: center top;
            margin-top: 40px;
            margin-bottom: 60px;
        }

        #guide-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 250px;
            color: #e0e0e0;
            pointer-events: none;
            user-select: none;
            z-index: 1;
        }

        #arrow-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 3;
            cursor: crosshair;
            touch-action: none;
        }

        .controls {
            margin-top: 20px;
        }

        .btn-action {
            background-color: #ff7043;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1.2em;
            border-radius: 50px;
            font-family: 'Jua', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* Success Message Overlay */
        #success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #success-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .success-text {
            font-size: 4em;
            color: #ffca28;
            /* Amber */
            text-shadow: 2px 2px 0px #fff, 4px 4px 0px #ff6f00;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-20px);
            }
        }

        /* Arrow Styles */
        .guide-arrow {
            fill: none;
            stroke: rgba(255, 112, 67, 0.6);
            stroke-width: 5;
            stroke-dasharray: 10 5;
            marker-end: url(#arrowhead);
            animation: dash 1s linear infinite;
        }

        /* Highlight current Arrow */
        .guide-arrow.active {
            stroke: rgba(255, 87, 34, 1);
            stroke-width: 7;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -15;
            }
        }

        .stroke-number {
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(255, 87, 34, 0.9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 4;
            transform: translate(-50%, -50%);
            /* Center over coordinate */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            opacity: 0;
            /* Hidden by default */
            transition: opacity 0.3s;
        }

        .stroke-number.active {
            opacity: 1;
        }
    </style>
</head>

<body>

    <a href="index.html" class="home-btn">üè† ÌôàÏúºÎ°ú</a>
    <h1>ÌïúÍ∏Ä ÏûêÏùå Ïì∞Í∏∞</h1>

    <div class="selector-container" id="selector"></div>

    <div id="canvas-container">
        <div id="guide-layer">„Ñ±</div>
        <!-- SVG for Arrows -->
        <svg id="arrow-layer" width="300" height="400">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255, 112, 67, 0.6)" />
                </marker>
            </defs>
            <!-- Paths will be injected JS -->
        </svg>
        <canvas id="drawCanvas" width="300" height="400"></canvas>
    </div>

    <div class="controls">
        <button class="btn-action" onclick="resetCanvas()">ÏßÄÏö∞Í∏∞ (Îã§ÏãúÌïòÍ∏∞)</button>
    </div>

    <div id="success-overlay">
        <div class="success-text">Ï∞∏ ÏûòÌñàÏñ¥Ïöî!</div>
        <button class="btn-action" style="background:#4caf50; margin-top:20px;" onclick="nextChar()">Îã§Ïùå Í∏ÄÏûê!</button>
    </div>

    <script>
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const guideEl = document.getElementById('guide-layer');
        const arrowLayer = document.getElementById('arrow-layer');
        const successOverlay = document.getElementById('success-overlay');
        const selectorContainer = document.getElementById('selector');

        const width = 300;
        const height = 400;

        // --- Data Structure Refactor: Array of Strokes ---
        // Each consonant has an array of 'strokes'.
        // Each 'stroke' has: { path: "...", num: {x, y, text}, checkpoints: [{x,y}, ...] }
        // Coordinates kept from "Internal Box" refinement.

        const consonants = [
            {
                char: '„Ñ±',
                strokes: [
                    {
                        // Single stroke
                        path: "M 80 110 L 220 110 L 220 270",
                        num: { x: 80, y: 110, text: "1" },
                        checkpoints: [{ x: 80, y: 110 }, { x: 220, y: 110 }, { x: 220, y: 270 }]
                    }
                ]
            },
            {
                char: '„Ñ¥',
                strokes: [
                    {
                        path: "M 80 110 L 80 270 L 220 270",
                        num: { x: 80, y: 110, text: "1" },
                        checkpoints: [{ x: 80, y: 110 }, { x: 80, y: 270 }, { x: 220, y: 270 }]
                    }
                ]
            },
            {
                char: '„Ñ∑',
                strokes: [
                    {
                        // Stroke 1: Top horizontal
                        path: "M 85 115 L 215 115",
                        num: { x: 85, y: 115, text: "1" },
                        checkpoints: [{ x: 85, y: 115 }, { x: 215, y: 115 }]
                    },
                    {
                        // Stroke 2: C-shape
                        path: "M 85 155 L 85 270 L 215 270",
                        num: { x: 85, y: 155, text: "2" },
                        checkpoints: [{ x: 85, y: 155 }, { x: 85, y: 270 }, { x: 215, y: 270 }]
                    }
                ]
            },
            {
                char: '„Ñπ',
                strokes: [
                    {
                        // S1: Top zigzag
                        path: "M 85 110 L 215 110 L 215 180",
                        num: { x: 85, y: 110, text: "1" },
                        checkpoints: [{ x: 85, y: 110 }, { x: 215, y: 110 }, { x: 215, y: 180 }]
                    },
                    {
                        // S2: Middle horiz
                        path: "M 85 180 L 215 180",
                        num: { x: 85, y: 180, text: "2" },
                        checkpoints: [{ x: 85, y: 180 }, { x: 215, y: 180 }]
                    },
                    {
                        // S3: Bottom L
                        path: "M 85 180 L 85 270 L 215 270",
                        num: { x: 85, y: 210, text: "3" },
                        checkpoints: [{ x: 85, y: 270 }, { x: 215, y: 270 }] // Simplified checkpoints allowing start fromprev
                    }
                ]
            },
            {
                char: '„ÖÅ',
                strokes: [
                    {
                        // S1: Left vertical
                        path: "M 85 120 L 85 270",
                        num: { x: 85, y: 120, text: "1" },
                        checkpoints: [{ x: 85, y: 120 }, { x: 85, y: 270 }]
                    },
                    {
                        // S2: Top-Right
                        path: "M 85 120 L 215 120 L 215 270",
                        num: { x: 105, y: 120, text: "2" },
                        checkpoints: [{ x: 215, y: 120 }, { x: 215, y: 270 }] // Assume start is near S1
                    },
                    {
                        // S3: Bottom
                        path: "M 85 270 L 215 270",
                        num: { x: 85, y: 270, text: "3" },
                        checkpoints: [{ x: 85, y: 270 }, { x: 215, y: 270 }]
                    }
                ]
            },
            {
                char: '„ÖÇ',
                strokes: [
                    {
                        path: "M 85 110 L 85 270",
                        num: { x: 85, y: 110, text: "1" },
                        checkpoints: [{ x: 85, y: 110 }, { x: 85, y: 270 }]
                    },
                    {
                        path: "M 215 110 L 215 270",
                        num: { x: 215, y: 110, text: "2" },
                        checkpoints: [{ x: 215, y: 110 }, { x: 215, y: 270 }]
                    },
                    {
                        path: "M 85 190 L 215 190",
                        num: { x: 150, y: 190, text: "3" },
                        checkpoints: [{ x: 85, y: 190 }, { x: 215, y: 190 }]
                    },
                    {
                        path: "M 85 270 L 215 270",
                        num: { x: 150, y: 270, text: "4" },
                        checkpoints: [{ x: 85, y: 270 }, { x: 215, y: 270 }]
                    }
                ]
            },
            {
                char: '„ÖÖ',
                strokes: [
                    {
                        path: "M 150 90 L 75 280",
                        num: { x: 150, y: 90, text: "1" },
                        checkpoints: [{ x: 150, y: 90 }, { x: 75, y: 280 }]
                    },
                    {
                        path: "M 150 140 L 225 280",
                        num: { x: 180, y: 160, text: "2" },
                        checkpoints: [{ x: 150, y: 140 }, { x: 225, y: 280 }]
                    }
                ]
            },
            {
                char: '„Öá',
                strokes: [
                    {
                        path: "M 150 90 C 50 90 50 300 150 300 C 250 300 250 90 150 90",
                        num: { x: 150, y: 90, text: "1" },
                        checkpoints: [{ x: 150, y: 90 }, { x: 70, y: 195 }, { x: 150, y: 300 }, { x: 230, y: 195 }]
                    }
                ]
            },
            {
                char: '„Öà',
                strokes: [
                    {
                        path: "M 75 90 L 225 90",
                        num: { x: 75, y: 90, text: "1" },
                        checkpoints: [{ x: 75, y: 90 }, { x: 225, y: 90 }]
                    },
                    {
                        path: "M 150 90 L 75 280",
                        num: { x: 150, y: 90, text: "2" },
                        checkpoints: [{ x: 150, y: 90 }, { x: 75, y: 280 }]
                    },
                    {
                        path: "M 150 190 L 225 280",
                        num: { x: 150, y: 190, text: "3" },
                        checkpoints: [{ x: 150, y: 190 }, { x: 225, y: 280 }]
                    }
                ]
            },
            {
                char: '„Öä',
                strokes: [
                    {
                        path: "M 85 65 L 215 65",
                        num: { x: 85, y: 65, text: "1" },
                        checkpoints: [{ x: 85, y: 65 }, { x: 215, y: 65 }]
                    },
                    {
                        path: "M 75 100 L 225 100",
                        num: { x: 75, y: 100, text: "2" },
                        checkpoints: [{ x: 75, y: 100 }, { x: 225, y: 100 }]
                    },
                    {
                        path: "M 150 100 L 75 280",
                        num: { x: 150, y: 100, text: "3" },
                        checkpoints: [{ x: 150, y: 100 }, { x: 75, y: 280 }]
                    },
                    {
                        path: "M 150 190 L 225 280",
                        num: { x: 150, y: 190, text: "4" },
                        checkpoints: [{ x: 150, y: 190 }, { x: 225, y: 280 }]
                    }
                ]
            },
            {
                char: '„Öã',
                strokes: [
                    {
                        path: "M 80 110 L 220 110 L 220 270",
                        num: { x: 80, y: 110, text: "1" },
                        checkpoints: [{ x: 80, y: 110 }, { x: 220, y: 110 }, { x: 220, y: 270 }]
                    },
                    {
                        path: "M 80 190 L 220 190",
                        num: { x: 80, y: 190, text: "2" },
                        checkpoints: [{ x: 80, y: 190 }, { x: 220, y: 190 }]
                    }
                ]
            },
            {
                char: '„Öå',
                strokes: [
                    {
                        path: "M 80 110 L 220 110",
                        num: { x: 80, y: 110, text: "1" },
                        checkpoints: [{ x: 80, y: 110 }, { x: 220, y: 110 }]
                    },
                    {
                        path: "M 80 190 L 220 190",
                        num: { x: 80, y: 190, text: "2" },
                        checkpoints: [{ x: 80, y: 190 }, { x: 220, y: 190 }]
                    },
                    {
                        path: "M 80 110 L 80 270 L 220 270",
                        num: { x: 80, y: 230, text: "3" },
                        checkpoints: [{ x: 80, y: 270 }, { x: 220, y: 270 }] // Simplified
                    }
                ]
            },
            {
                char: '„Öç',
                strokes: [
                    {
                        path: "M 75 110 L 225 110",
                        num: { x: 75, y: 110, text: "1" },
                        checkpoints: [{ x: 75, y: 110 }, { x: 225, y: 110 }]
                    },
                    {
                        path: "M 105 110 L 105 270",
                        num: { x: 105, y: 110, text: "2" },
                        checkpoints: [{ x: 105, y: 110 }, { x: 105, y: 270 }]
                    },
                    {
                        path: "M 195 110 L 195 270",
                        num: { x: 195, y: 110, text: "3" },
                        checkpoints: [{ x: 195, y: 110 }, { x: 195, y: 270 }]
                    },
                    {
                        path: "M 75 270 L 225 270",
                        num: { x: 75, y: 270, text: "4" },
                        checkpoints: [{ x: 75, y: 270 }, { x: 225, y: 270 }]
                    }
                ]
            },
            {
                char: '„Öé',
                strokes: [
                    {
                        path: "M 120 70 L 180 70",
                        num: { x: 100, y: 70, text: "1" },
                        checkpoints: [{ x: 150, y: 70 }]
                    },
                    {
                        path: "M 75 110 L 225 110",
                        num: { x: 65, y: 110, text: "2" },
                        checkpoints: [{ x: 75, y: 110 }, { x: 225, y: 110 }]
                    },
                    {
                        path: "M 150 160 C 40 160 40 310 150 310 C 260 310 260 160 150 160",
                        num: { x: 150, y: 160, text: "3" },
                        checkpoints: [{ x: 150, y: 160 }, { x: 70, y: 240 }, { x: 150, y: 310 }, { x: 230, y: 240 }]
                    }
                ]
            }
        ];

        let currentIndex = 0;
        let isDrawing = false;

        // --- Sequential Stroke Logic ---
        let currentStrokeIndex = 0; // Which stroke are we on? (0, 1, 2...)
        let strokePassedCheckpoints = []; // Checkpoints passed for the *current* stroke

        // Init Selector
        const charList = ['„Ñ±', '„Ñ¥', '„Ñ∑', '„Ñπ', '„ÖÅ', '„ÖÇ', '„ÖÖ', '„Öá', '„Öà', '„Öä', '„Öã', '„Öå', '„Öç', '„Öé'];
        charList.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.className = 'char-btn';
            btn.innerText = c;
            btn.onclick = () => setChar(idx);
            selectorContainer.appendChild(btn);
        });

        function setChar(index) {
            currentIndex = index;
            const char = charList[index];
            guideEl.innerText = char;

            // Highlight button
            document.querySelectorAll('.char-btn').forEach((b, i) => {
                b.classList.toggle('active', i === index);
            });

            // Start Stroke 0
            currentStrokeIndex = 0;
            resetCanvas();
            updateGuides();
        }

        // Render *only* the current stroke's guide
        function updateGuides() {
            // Clear all guides
            arrowLayer.innerHTML = `<defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255, 112, 67, 0.6)" />
                </marker>
            </defs>`;
            // Remove floating numbers
            const existingNums = arrowLayer.parentNode.querySelectorAll('.stroke-number');
            existingNums.forEach(e => e.remove());

            const data = consonants[currentIndex];
            if (!data || currentStrokeIndex >= data.strokes.length) return;

            const stroke = data.strokes[currentStrokeIndex];

            // Draw Arrow
            const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathEl.setAttribute("d", stroke.path);
            pathEl.setAttribute("class", "guide-arrow active");
            arrowLayer.appendChild(pathEl);

            // Draw Number
            const numEl = document.createElement('div');
            numEl.className = 'stroke-number active';
            numEl.innerText = stroke.num.text;
            numEl.style.left = stroke.num.x + 'px';
            numEl.style.top = stroke.num.y + 'px';
            arrowLayer.parentNode.appendChild(numEl);

            // Init Validation for this stroke
            strokePassedCheckpoints = new Array(stroke.checkpoints.length).fill(false);
        }

        // --- Drawing Logic ---
        ctx.strokeStyle = '#2e7d32'; // Dark Green
        ctx.lineWidth = 50; // Thicker for better coverage
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (canvas.width / rect.width),
                y: (clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            validateCheckpoint(pos.x, pos.y); // Check start
            e.preventDefault();
        }

        function moveDraw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            validateCheckpoint(pos.x, pos.y);
            e.preventDefault();
        }

        function endDraw() {
            if (!isDrawing) return;
            isDrawing = false;
            // No strict "fail" on lift, just wait for resumption
            // Check if stroke was completed in moveDraw
        }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', moveDraw);
        window.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', startDraw, { passive: false });
        canvas.addEventListener('touchmove', moveDraw, { passive: false });
        canvas.addEventListener('touchend', endDraw);

        function resetCanvas() {
            ctx.clearRect(0, 0, width, height);
            closeSuccess();
            // Reset stroke logic
            currentStrokeIndex = 0;
            updateGuides();
        }

        function validateCheckpoint(x, y) {
            const data = consonants[currentIndex];
            if (!data || currentStrokeIndex >= data.strokes.length) return;

            const stroke = data.strokes[currentStrokeIndex];
            const checkpoints = stroke.checkpoints;

            // Simple Flexible Val: Use standard radius
            // Find next unpassed
            const nextIndex = strokePassedCheckpoints.indexOf(false);
            if (nextIndex === -1) return; // All passed for this stroke

            const target = checkpoints[nextIndex];
            const dist = Math.sqrt(Math.pow(x - target.x, 2) + Math.pow(y - target.y, 2));

            // Increased radius (65) for flexibility
            if (dist < 65) {
                strokePassedCheckpoints[nextIndex] = true;

                // If Stroke Complete?
                if (strokePassedCheckpoints.every(p => p === true)) {
                    // Stroke Done!
                    completeStroke();
                }
            }
        }

        function completeStroke() {
            console.log(`Stroke ${currentStrokeIndex + 1} Done`);

            // Add a small delay so user sees "done" status or just feels the beat
            setTimeout(() => {
                // Advance
                currentStrokeIndex++;

                const data = consonants[currentIndex];
                if (currentStrokeIndex >= data.strokes.length) {
                    // All strokes done -> Check Pixel Coverage
                    finallizeCharacter();
                } else {
                    // Show next guide
                    updateGuides();
                }
            }, 500); // 500ms delay
        }

        function finallizeCharacter() {
            // 2. Pixel Coverage Check (Validation Buffer)
            const targetCanvas = document.createElement('canvas');
            targetCanvas.width = width;
            targetCanvas.height = height;
            const targetCtx = targetCanvas.getContext('2d');

            targetCtx.font = "250px 'Jua', sans-serif";
            targetCtx.textAlign = "center";
            targetCtx.textBaseline = "middle";
            targetCtx.fillStyle = "black";
            targetCtx.fillText(charList[currentIndex], width / 2, height / 2);

            const userImg = ctx.getImageData(0, 0, width, height).data;
            const targetImg = targetCtx.getImageData(0, 0, width, height).data;

            let targetPixels = 0;
            let coveredPixels = 0;

            for (let i = 3; i < targetImg.length; i += 4) {
                if (targetImg[i] > 100) {
                    targetPixels++;
                    if (userImg[i] > 50) coveredPixels++;
                }
            }

            const coverage = coveredPixels / targetPixels;
            console.log(`Coverage: ${(coverage * 100).toFixed(1)}%`);

            // Flexible threshold
            if (coverage > 0.3) {
                showSuccess();
            } else {
                console.log("Coverage too low, try again");
                // Maybe auto-clear or let user clear?
                // Let's let user modify or clear manually
            }
        }

        let autoAdvanceTimer = null;
        function showSuccess() {
            successOverlay.classList.add('show');
            // Remove guides
            arrowLayer.innerHTML = "";
            const existingNums = arrowLayer.parentNode.querySelectorAll('.stroke-number');
            existingNums.forEach(e => e.remove());

            const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg');
            // audio.play().catch(e => {});

            autoAdvanceTimer = setTimeout(() => {
                nextChar();
            }, 3000);
        }

        function nextChar() {
            if (autoAdvanceTimer) clearTimeout(autoAdvanceTimer);
            let next = currentIndex + 1;
            if (next >= charList.length) next = 0;
            setChar(next);
            closeSuccess();
        }

        function closeSuccess() {
            successOverlay.classList.remove('show');
        }

        // Init
        setChar(0); // Start with „Ñ±

    </script>
</body>

</html>